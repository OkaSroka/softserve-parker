#!/bin/bash -e -x

echo "Building backend..."
cd ../backend
npm ci
npm run build

echo "Deploying database migrations..."
cd ../backend
npm run db:migrate

echo "Deploying application..."
sudo pm2 stop parker
rm -rf /var/lib/parker/*
cp -r app /var/lib/parker/
cp -r node_modules /var/lib/parker/
cp tsconfig.json /var/lib/parker/
cp database.json /var/lib/parker/
cp ecosystem.config.js /var/lib/parker/

sudo pm2 restart parker

echo "Deploying Apache configuration..."
cd ../deployment
sudo cp apache/001-parker.conf /etc/apache2/sites-available/
sudo a2ensite 001-parker.conf
sudo service apache2 reload

function deploy() {
  echo "Deploying frontend branch $1 in version $2"

  tmp=$(mktemp -d -t parker-XXXXXXXXXX)
  echo "Temp dir: $tmp, current dir: $(pwd)"

  git --work-tree $tmp checkout $1 -- frontend
  cd "$tmp/frontend"
  npm install
  npm run build
  npm run deploy -- --version $2
  cd -

  rm -rf $tmp
}

cd ..

echo "Deploying frontend... $(pwd)"

for ref in $@;
do
  branch=$(basename $ref)
  if [ "$branch" != "master" ];
  then
    deploy $branch $branch
  else
    deploy $branch "release"
  fi
done
