#!/bin/sh

echo "Building backend..."
cd ../backend
npm ci
npm run build

echo "Building frontend..."
cd ../frontend
npm ci
npm run build

echo "Deploying frontend..."
cd ../frontend/dist
rm -rf /var/lib/parker/frontend/*
cp -r * /var/lib/parker/frontend/

echo "Deploying database migrations"
cd ../../backend
npm run db:migrate

echo "Deploying backend..."
cd dist
rm -rf /var/lib/parker/backend/*
cp -r * /var/lib/parker/backend/
cd ..
cp -r node_modules /var/lib/parker/backend/
cp ecosystem.config.js /var/lib/parker/backend/
sudo pm2 restart parker-backend

echo "Deploying Apache configuration..."
cd ../deployment/apache
sudo cp 001-parker.conf /etc/apache2/sites-available/
sudo a2ensite 001-parker.conf
sudo service apache2 reload
